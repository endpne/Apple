name: macOS Testflight
on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Name of the branch"
        required: false
        default: ""

permissions:
  contents: write  

jobs:
  build-and-release:
    runs-on: macos-26
    steps:
      - name: üõ†Ô∏è Checkout repository
        uses: actions/checkout@v4
        with:
            repository: saltpi/iPlay.Apple
            ref: 'dev/kernel'
            token: ${{ secrets.REPO_TOKEN }}
            submodules: recursive
            fetch-depth: 0

      - name: üîë Import code sign
        continue-on-error: true
        uses: apple-actions/import-codesign-certs@v3
        with:
          p12-file-base64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
          p12-password: ${{ secrets.BUILD_CERTIFICATE_PASSWORD }}
        
      - name: üìÑ Download provisioning profiles
        uses: apple-actions/download-provisioning-profiles@v4
        with:
          bundle-id: top.ourfor.app.iPlayClient
          issuer-id: ${{ secrets.APPSTORE_ISSUER_ID }}
          api-key-id: ${{ secrets.APPSTORE_API_KEY_ID }}
          api-private-key: ${{ secrets.APPSTORE_API_PRIVATE_KEY }}

      - name: üìÑ Download provisioning profiles
        uses: apple-actions/download-provisioning-profiles@v4
        with:
          bundle-id: top.ourfor.app.iPlayClient.Safari
          issuer-id: ${{ secrets.APPSTORE_ISSUER_ID }}
          api-key-id: ${{ secrets.APPSTORE_API_KEY_ID }}
          api-private-key: ${{ secrets.APPSTORE_API_PRIVATE_KEY }}

      - name: üî¢ Update Build Number
        id: update_build_number
        uses: saltpi/update-testflight-build-number@v5
        with:
          app-id: '6480576133'
          platform: 'MAC_OS'
          issuer-id: ${{ secrets.APPSTORE_ISSUER_ID }}
          api-key-id: ${{ secrets.APPSTORE_API_KEY_ID }}
          api-private-key: ${{ secrets.APPSTORE_API_PRIVATE_KEY }}

      - name: üßæ Print Build Number
        run: |
          echo "Build Number: ${{ steps.update_build_number.outputs.build-number }}"
          cat iPlay.xcodeproj/project.pbxproj | grep -A 1 'CURRENT_PROJECT_VERSION = '

      - name: ‚è∞ SPM cache
        uses: actions/cache@v4
        with:
          path: .build
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-
          
      - name: üöÄ Build app
        shell: bash
        run: |
          git apply script/macos/*.patch --allow-empty
          next_build_number=$((${{ steps.update_build_number.outputs.build-number }} + 1))
          export BUILD_NUMBER=$next_build_number
          ./script/build_macos.sh
          ls .build/Artifacts

      - name: ‚òÅÔ∏è Upload to TestFlight
        uses: apple-actions/upload-testflight-build@v3
        with:
          app-path: .build/Artifacts/iPlay.pkg
          issuer-id: ${{ secrets.APPSTORE_ISSUER_ID }}
          api-key-id: ${{ secrets.APPSTORE_API_KEY_ID }}
          api-private-key: ${{ secrets.APPSTORE_API_PRIVATE_KEY }}

      # - name: ‚òÅÔ∏è Upload to Onedrive
      #   run: |
      #     version_code="$(git rev-list --count HEAD)"
      #     buildtime=$(date '+%Y%m%d.%H%M')
      #     wget https://drive.ourfor.top/tools/upload_session.py -O upload.py
      #     python -m pip install requests tqdm
      #     python upload.py --url "https://drive.ourfor.top/od_bot/build/iPlay/macOS/iPlay_build_${version_code}.pkg" \
      #       --file "$PWD/.build/Artifacts/iPlay.pkg" \
      #       --token "${{ secrets.ONEDRIVE_CLIENT_ID }}"
      #     python upload.py --url "https://drive.ourfor.top/od_bot/build/iPlay/macOS/iPlay_build_${version_code}.dmg" \
      #       --file "$PWD/.build/Artifacts/iPlay.dmg" \
      #       --token "${{ secrets.ONEDRIVE_CLIENT_ID }}"
      #     echo "https://drive.ourfor.top/od_bot/build/iPlay/macOS/iPlay_build_${version_code}.dmg" > "$PWD/.build/Artifacts/latest.dmg.url"
      #     python upload.py --url "https://drive.ourfor.top/od_bot/build/iPlay/macOS/latest.dmg.url" \
      #       --file "$PWD/.build/Artifacts/latest.dmg.url" \
      #       --token "${{ secrets.ONEDRIVE_CLIENT_ID }}"
      #     python upload.py --url "https://drive.ourfor.top/od_kiss/iplay/appcast.xml" \
      #       --file "$PWD/.build/Artifacts/appcast.xml" \
      #       --token "${{ secrets.ONEDRIVE_CLIENT_ID }}"
      #   shell: bash
      - name: üè∑Ô∏è Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: macos-build-${{ steps.update_build_number.outputs.build-number }}
          name: macOS Build ${{ steps.update_build_number.outputs.build-number }}
          make_latest: true
          body: |
            macOS TestFlight Build ${{ steps.update_build_number.outputs.build-number }}
            
            Build artifacts:
            - iPlay.pkg (TestFlight package)
            - iPlay.dmg (Direct installation)
            
            **Installation Options:**
            1. Use the .pkg file for TestFlight distribution
            2. Use the .dmg file for direct installation
          files: |
            .build/Artifacts/iPlay.pkg
            .build/Artifacts/iPlay.dmg
            .build/Artifacts/appcast.xml
